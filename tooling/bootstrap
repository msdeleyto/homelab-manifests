#!/bin/bash

set -euo pipefail

# Verify requirements
verify_requirements() {
  error="0"

  if ! which kubectl 2>&1 > /dev/null; then
    echo "    [!] kubectl not detected!"
    error="1"
  fi

  if ! which helm 2>&1 > /dev/null; then
    echo "    [!] helm not detected!"
    error="1"
  fi

  if [[ "${error}" == "1" ]]; then
    exit 1
  fi
}

vault_secrets="$1"
vault_secret_files="$2"

project_path="$(dirname $0)/.."

echo "[+] Verifying requirements..."
verify_requirements "${project_path}"
echo -e "    Everything ready!\\n"

# Install gateway crds
kubectl apply --server-side -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.1/standard-install.yaml > /dev/null

# Install CNI
# echo "[1/6] Bootstraping CNI..."
# "${project_path}"/network/tooling/bootstrap
# echo -e "   CNI ready!\\n"

# Install storage
echo "[2/6] Bootstraping storage..."
# "${project_path}"/longhorn-system/tooling/bootstrap
echo -e "   Storage ready!\\n"

# Install Vault
echo "[3/6] Bootstraping vault..."
"${project_path}"/vault/tooling/bootstrap "${vault_secrets}" "${vault_secret_files}"
echo -e "   Vault ready!\\n"

# Install ESO
echo "[4/6] Bootstraping ESO..."
"${project_path}"/external-secrets/tooling/bootstrap
echo -e "   ESO ready!\\n"

echo "[5/6] Bootstraping Vault unsealer..."
"${project_path}"/vault/tooling/bootstrap-unsealer
echo -e "   Unsealer ready!\\n"

# Install ArgoCD
echo "[6/6] Bootstraping ArgoCD..."
"${project_path}"/devops-tools/tooling/bootstrap
echo -e "   Devops-tools ready!\\n"

echo "[+] Cluster services ready!"
