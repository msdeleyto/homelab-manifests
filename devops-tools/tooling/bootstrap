#!/bin/bash

set -euo pipefail

# Add helm repository for argocd
helm repo add argo https://argoproj.github.io/argo-helm > /dev/null && \
  helm repo update > /dev/null

# Install CRDs
kubectl apply --server-side -k https://github.com/argoproj/argo-cd/manifests/crds\?ref\=stable > /dev/null

kubectl create namespace devops-tools 2>/dev/null || true

project_path="$(dirname $0)/.."
argocd_dir="${project_path}/argocd"

kubectl apply --server-side -f "${argocd_dir}/external-secrets.yaml"
kubectl kustomize --enable-helm "${argocd_dir}" | envsubst '${INFRA_DOMAIN} ${INFRA_ENV}' | kubectl apply --server-side -f - > /dev/null

echo -e "Done!\n"
