#!/bin/bash

set -eu

# Add helm repository for argocd
helm repo add argo https://argoproj.github.io/argo-helm && \
  helm repo update

kubectl create namespace devops-tools || true

# argocd
echo -e "\nDeploying argocd..."
argocd_dir="$(dirname $0)/../argocd"

# Replace secrets
sed -i "s|<path:secret/data/infra#domain>|${DOMAIN}|" "${argocd_dir}"/values.yaml
sed -i "s|<path:secret/data/infra#env>|${ENV}|" "${argocd_dir}"/values.yaml
sed -i "s|<path:secret/data/devopstools/argocd#admin_password>|${ARGOCD_PASSWORD}|" "${argocd_dir}"/values.yaml
sed -i "s|<path:secret/data/devopstools/argocd#gh_org1_username>|${ARGOCD_GH_ORG1_USERNAME}|" "${argocd_dir}"/values.yaml
sed -i "s|<path:secret/data/devopstools/argocd#gh_org1_password>|${ARGOCD_GH_ORG1_PASSWORD}|" "${argocd_dir}"/values.yaml

sed -i "s|<path:secret/data/infra#env>|${ENV}|" "${argocd_dir}"/application.yaml

kubectl apply -f "${argocd_dir}"/secret.yaml

# Install CRDs
kubectl apply --server-side -k https://github.com/argoproj/argo-cd/manifests/crds\?ref\=stable

kubectl kustomize "${argocd_dir}" --enable-helm | kubectl apply -f -

echo -e "Done!\n"
