configs:
  params:
    server.insecure: true
  clusterCredentials:
    homelab:
      server: https://kubernetes.default.svc
      config:
        tlsClientConfig:
          insecure: true
  secret:
    createSecret: false
  cmp:
    create: true
    plugins:
      infra-envsubst:
        generate:
          command:
          - bash
          - -c
          - |
            set -e
            echo "Replacing env vars in manifests" >&2
            if [[ -f kustomization.yaml ]]; then
              kustomize build . --enable-helm | envsubst "$(printf '${%s} ' $(env | cut -d'=' -f1))"
            else
              echo "[!] Error during infra variables substitution" >&2
              exit 1
            fi
        discover:
          find:
            command: [sh, -c, find . -name kustomization.yaml]

  cm:
    resource.customizations: |
      argoproj.io/Application:
        health.lua: |
          hs = {}
          hs.status = "Progressing"
          hs.message = ""
          if obj.status ~= nil then
            if obj.status.health ~= nil then
              hs.status = obj.status.health.status
              if obj.status.health.message ~= nil then
                hs.message = obj.status.health.message
              end
            end
          end
          return hs
    resource.customizations.ignoreDifferences.admissionregistration.k8s.io_ValidatingWebhookConfiguration: |
      jqPathExpressions:
      - .webhooks[] | select((.name == "validation.istio.io") or .name == "rev.validation.istio.io") | .failurePolicy
    resource.customizations.ignoreDifferences.external-secrets.io_ExternalSecret: |
      jqPathExpressions:
      - .spec.data[].remoteRef.conversionStrategy
      - .spec.data[].remoteRef.decodingStrategy
      - .spec.data[].remoteRef.metadataPolicy

dex:
  enabled: false

redis:
  enabled: true

controller:
  replicas: 1
  metrics:
    enabled: true

server:
  replicas: 1
  metrics:
    enabled: true
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
    tls: true

repoServer:
  replicas: 1
  metrics:
    enabled: true
  rbac:
  - verbs:
    - get
    apiGroups:
    - ''
    resources:
    - configmaps
  volumes:
  - name: cmp-plugin
    configMap:
      name: argocd-cmp-cm
  - emptyDir: {}
    name: custom-tools
  initContainers:
  - name: download-envsubst
    image: ubuntu:latest
    command: ["sh", "-ce"]
    args:
      - |
        apt-get update && \
          apt-get install -y binutils curl xz-utils

        curl http://ftp.de.debian.org/debian/pool/main/g/gettext/gettext-base_0.23.2-1_amd64.deb -o gettext.deb

        ar x gettext.deb
        tar -xf data.tar.* ./usr/bin/envsubst

        cp usr/bin/envsubst /custom-tools/envsubst
        chmod +x /custom-tools/envsubst
    volumeMounts:
    - mountPath: /custom-tools
      name: custom-tools
  extraContainers:
  - name: infra-envsubst
    command: [/var/run/argocd/argocd-cmp-server]
    image: quay.io/argoproj/argocd:v3.3.0
    securityContext:
      runAsNonRoot: true
      runAsUser: 999
    envFrom:
    - configMapRef:
        name: infra-config
    volumeMounts:
    - mountPath: /var/run/argocd
      name: var-files
    - mountPath: /home/argocd/cmp-server/plugins
      name: plugins
    - mountPath: /home/argocd/cmp-server/config/plugin.yaml
      subPath: infra-envsubst.yaml
      name: cmp-plugin
    - mountPath: /usr/local/bin/envsubst
      subPath: envsubst
      name: custom-tools
  automountServiceAccountToken: true

applicationSet:
  replicas: 1

global:
  domain: cd.${INFRA_DOMAIN}
